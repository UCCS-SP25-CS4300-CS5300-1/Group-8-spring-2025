{% extends "base.html" %}

{% block title %}Map - LeafQuest{% endblock %}

{% block content %}

<h2 class="mb-4">Map</h2>
<p>Click on map to add pin.</p>

<div id="map" style="height: 500px; width: 100%;"></div>

<script>
  let map;
  let markers = [];

  function initMap() {
    const center = { lat: 38.859055, lng: -104.813499 };
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 8,
      center: center,
    });

    // Load existing pins
    fetch('/api/pins/')
      .then(res => res.json())
      .then(pins => {
        pins.forEach(pin => addMarkerFromData(pin));
      });

    // Add pin on click
    map.addListener("click", function (e) {
      const name = prompt("Enter a name for this pin:");
      if (!name) return;

      const lat = e.latLng.lat();
      const lng = e.latLng.lng();

      fetch('/api/pins/save/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, lat, lng })
      })
      .then(res => res.json())
      .then(data => {
        addMarkerFromData({ id: data.id, name, lat, lng });
      });
    });
  }

  function addMarkerFromData(pin) {
    const marker = new google.maps.Marker({
      position: { lat: pin.lat, lng: pin.lng },
      map: map,
      title: pin.name,
    });

    const infoWindow = new google.maps.InfoWindow();

    function updateInfoWindow() {
      infoWindow.setContent(`
        <strong>${pin.name}</strong><br>
        <button onclick="editPin(${pin.id}, this)">Edit</button>
        <button onclick="deletePin(${pin.id}, this)">Delete</button>
      `);
    }

    updateInfoWindow();

    marker.addListener("click", () => {
      infoWindow.open(map, marker);
    });

    marker._pinId = pin.id;
    marker._infoWindow = infoWindow;
    marker._update = updateInfoWindow;

    markers.push(marker);
  }

  window.editPin = function(pinId, button) {
    const newName = prompt("Enter a new name:");
    if (!newName) return;

    fetch(`/api/pins/${pinId}/edit/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newName })
    })
    .then(res => res.json())
    .then(data => {
      const marker = markers.find(m => m._pinId === pinId);
      if (marker) {
        marker.setTitle(data.name);
        marker._infoWindow.setContent(`
          <strong>${data.name}</strong><br>
          <button onclick="editPin(${pinId}, this)">Edit</button>
          <button onclick="deletePin(${pinId}, this)">Delete</button>
        `);
      }
    });
  };

  window.deletePin = function(pinId, button) {
    if (!confirm("Are you sure you want to delete this pin?")) return;

    fetch(`/api/pins/${pinId}/delete/`, {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const marker = markers.find(m => m._pinId === pinId);
        if (marker) {
          marker.setMap(null);
          markers = markers.filter(m => m._pinId !== pinId);
        }
      }
    });
  };
</script>

<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFB4eRGGAU_Z9_ZpzxgpqzKNYUHV-TNdE&callback=initMap">
</script>

{% endblock %}
