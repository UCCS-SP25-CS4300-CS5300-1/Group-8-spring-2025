
{% extends "base.html" %}

{% block title %}Capture - LeafQuest{% endblock %}

{% block content %}
    <h2>Capture an Image</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="image">Choose or Capture an Image:</label>
        <input type="file" name="image" id="image" accept="image/*" capture="environment" required>

        <button type="submit">Upload</button>
    </form>
    
    <hr>
    
    <h3>OR</h3>

    <h2>Use Camera (Advanced)</h2>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <button id="capture">Capture Image</button>
    <button id="upload" style="display: none;">Upload Captured Image</button>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture');
        const uploadBtn = document.getElementById('upload');

        // Request access to the camera
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
            })
            .catch(error => {
                console.error('Camera access denied:', error);
            });

        captureBtn.addEventListener('click', function () {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Convert to a data URL and create a file object
            canvas.toBlob(blob => {
                const file = new File([blob], "captured_image.jpg", { type: "image/jpeg" });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('image').files = dataTransfer.files;
                uploadBtn.style.display = 'block'; // Show upload button
            }, "image/jpeg");
        });
    </script>
{% endblock %}
